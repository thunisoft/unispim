/**	gbkmap模块
 *	gbkmap的generate以及检索功能。
 */

#include <assert.h>
#include <utility.h>
#include <gbk_map.h>
#include <tchar.h>
#include <pim_resource.h>
#include <share_segment.h>

static byte *gbk_map = 0;
const static int GBK_SCOPE[] = {
	0x00A4, 0x00A4, // 1
	0x00A7, 0x00A8, // 2
	0x00B0, 0x00B1, // 2
	0x00B7, 0x00B7, // 1
	0x00D7, 0x00D7, // 1
	0x00E0, 0x00E1, // 2
	0x00E8, 0x00EA, // 3
	0x00EC, 0x00ED, // 2
	0x00F2, 0x00F3, // 2
	0x00F7, 0x00F7, // 1
	0x00F9, 0x00FA, // 2
	0x00FC, 0x00FC, // 1
	0x0101, 0x0101, // 1
	0x0113, 0x0113, // 1
	0x011B, 0x011B, // 1
	0x012B, 0x012B, // 1
	0x0144, 0x0144, // 1
	0x0148, 0x0148, // 1
	0x014D, 0x014D, // 1
	0x016B, 0x016B, // 1
	0x01CE, 0x01CE, // 1
	0x01D0, 0x01D0, // 1
	0x01D2, 0x01D2, // 1
	0x01D4, 0x01D4, // 1
	0x01D6, 0x01D6, // 1
	0x01D8, 0x01D8, // 1
	0x01DA, 0x01DA, // 1
	0x01DC, 0x01DC, // 1
	0x0251, 0x0251, // 1
	0x0261, 0x0261, // 1
	0x02C7, 0x02C7, // 1
	0x02C9, 0x02CB, // 3
	0x02D9, 0x02D9, // 1
	0x0391, 0x03A1, // 17
	0x03A3, 0x03A9, // 7
	0x03B1, 0x03C1, // 17
	0x03C3, 0x03C9, // 7
	0x0401, 0x0401, // 1
	0x0410, 0x044F, // 64
	0x0451, 0x0451, // 1
	0x2010, 0x2010, // 1
	0x2013, 0x2016, // 4
	0x2018, 0x2019, // 2
	0x201C, 0x201D, // 2
	0x2025, 0x2026, // 2
	0x2030, 0x2030, // 1
	0x2032, 0x2033, // 2
	0x2035, 0x2035, // 1
	0x203B, 0x203B, // 1
	0x20AC, 0x20AC, // 1
	0x2103, 0x2103, // 1
	0x2105, 0x2105, // 1
	0x2109, 0x2109, // 1
	0x2116, 0x2116, // 1
	0x2121, 0x2121, // 1
	0x2160, 0x216B, // 12
	0x2170, 0x2179, // 10
	0x2190, 0x2193, // 4
	0x2196, 0x2199, // 4
	0x2208, 0x2208, // 1
	0x220F, 0x220F, // 1
	0x2211, 0x2211, // 1
	0x2215, 0x2215, // 1
	0x221A, 0x221A, // 1
	0x221D, 0x2220, // 4
	0x2223, 0x2223, // 1
	0x2225, 0x2225, // 1
	0x2227, 0x222B, // 5
	0x222E, 0x222E, // 1
	0x2234, 0x2237, // 4
	0x223D, 0x223D, // 1
	0x2248, 0x2248, // 1
	0x224C, 0x224C, // 1
	0x2252, 0x2252, // 1
	0x2260, 0x2261, // 2
	0x2264, 0x2267, // 4
	0x226E, 0x226F, // 2
	0x2295, 0x2295, // 1
	0x2299, 0x2299, // 1
	0x22A5, 0x22A5, // 1
	0x22BF, 0x22BF, // 1
	0x2312, 0x2312, // 1
	0x2460, 0x2469, // 10
	0x2474, 0x249B, // 40
	0x2500, 0x254B, // 76
	0x2550, 0x2573, // 36
	0x2581, 0x258F, // 15
	0x2593, 0x2595, // 3
	0x25A0, 0x25A1, // 2
	0x25B2, 0x25B3, // 2
	0x25BC, 0x25BD, // 2
	0x25C6, 0x25C7, // 2
	0x25CB, 0x25CB, // 1
	0x25CE, 0x25CF, // 2
	0x25E2, 0x25E5, // 4
	0x2605, 0x2606, // 2
	0x2609, 0x2609, // 1
	0x2640, 0x2640, // 1
	0x2642, 0x2642, // 1
	0x3000, 0x3003, // 4
	0x3005, 0x3017, // 19
	0x301D, 0x301E, // 2
	0x3021, 0x3029, // 9
	0x3041, 0x3093, // 83
	0x309B, 0x309E, // 4
	0x30A1, 0x30F6, // 86
	0x30FC, 0x30FE, // 3
	0x3105, 0x3129, // 37
	0x3220, 0x3229, // 10
	0x3231, 0x3231, // 1
	0x32A3, 0x32A3, // 1
	0x338E, 0x338F, // 2
	0x339C, 0x339E, // 3
	0x33A1, 0x33A1, // 1
	0x33C4, 0x33C4, // 1
	0x33CE, 0x33CE, // 1
	0x33D1, 0x33D2, // 2
	0x33D5, 0x33D5, // 1
	0x4E00, 0x9FA5, // 20902
	0xE76C, 0xE76C, // 1
	0xE7C7, 0xE7C8, // 2
	0xE7E7, 0xE7F3, // 13
	//0xE815, 0xE864, // 80
	0xF92C, 0xF92C, // 1
	0xF979, 0xF979, // 1
	0xF995, 0xF995, // 1
	0xF9E7, 0xF9E7, // 1
	0xF9F1, 0xF9F1, // 1
	0xFA0C, 0xFA0F, // 4
	0xFA11, 0xFA11, // 1
	0xFA13, 0xFA14, // 2
	0xFA18, 0xFA18, // 1
	0xFA1F, 0xFA21, // 3
	0xFA23, 0xFA24, // 2
	0xFA27, 0xFA29, // 3
	0xFE30, 0xFE31, // 2
	0xFE33, 0xFE44, // 18
	0xFE49, 0xFE52, // 10
	0xFE54, 0xFE57, // 4
	0xFE59, 0xFE66, // 14
	0xFE68, 0xFE6B, // 4
	0xFF01, 0xFF5E, // 94
	0xFFE0, 0xFFE5  // 6
};

static TCHAR *gbkmap_share_name					= TEXT("HYPIM_GBKMAP_SHARED_NAME");

/**	GENERNATE GBKMAP到内存。
 *	返回：
 *		成功：1
 *		失败：0
 */
int GenGBKMapData()
{
	int i,j,pos_offset;
	byte pos_mask,*pos;

	if (share_segment->gbkmap_loaded)
		return 1;

	gbk_map = AllocateSharedMemory(gbkmap_share_name, GBKMAP_SIZE);
	if (!gbk_map)
		return 0;

	for ( i=0; i < sizeof(GBK_SCOPE)/sizeof(int)-1; i+=2 )
	{
		for ( j=GBK_SCOPE[i]; j <= GBK_SCOPE[i+1]; j++)
		{
			pos_offset = j >> 3;
			pos_mask = 1 << (j % 8);

			pos = (byte*)(gbk_map + pos_offset);
			*pos = (*pos) | pos_mask;			
		}
	}

	share_segment->gbkmap_loaded = 1;

	return 1;
}

/**	释放gbk MAP文件
 */
int FreeGBKMapData()
{
	share_segment->gbkmap_loaded = 0;

	if (gbk_map)
	{
		FreeSharedMemory(gbkmap_share_name, gbk_map);
		gbk_map = 0;
	}

	return 1;
}

int IsGBK(UC zi)
{
	int pos_offset;
	byte pos_mask,*pos;
	extern int GenGBKMapResource();

	if(!gbk_map)
	{
		gbk_map = GetReadOnlySharedMemory(gbkmap_share_name);

		//可能存在其他进程已经装载了，但是退出后共享内存被释放的问题
		if (!gbk_map && share_segment->gbkmap_loaded)
		{
			share_segment->gbkmap_loaded = 0;
			GenGBKMapResource();
		}
	}
	if(!gbk_map)
		return 1;

	if (zi > 0xFFFFF)
		return 0;

	////PUA
	//if ( !_tcscmp(pim_config->chinese_font_name,TEXT("微软雅黑")) && zi >= 0xE000 && zi <= 0xF8FF )
	//	return 0;

	pos_offset = zi >> 3;
	pos_mask = 1 << (zi % 8);

	pos = (byte*)(gbk_map + pos_offset);

	return (*pos) & pos_mask;
}